import{helperUtils as e}from"./helperUtils.js";import{extendConfig as t}from"../config/config.js";export class helperBackend{static async getBackend(e,t){let s={};return"skill"===t&&(s.rules=this.configRules(),s.characteristics=this.getCharacteristics(e),s.parentSkills=await this.getParentSkills(e.document.pack,e.document.parent)),"trait"===t&&(s.rules=this.configRules(),s.characteristics=this.getCharacteristics(e),s.secondaries=this.getSecondaries(),s.skills=await this.getSimpleCompendiumSkills(!1),s.combatSkills=await this.getCompendiumCombatSkills(!1),s.socialMods=this.getSocialMods(),s.locations=this.configLocations(!0),s.money=this.getMoneyTypes()),"action"===t&&(s.rules=this.configRules(),s.skills=await this.getSimpleCompendiumSkills(!0),s.locations=this.configLocations(!0),s.weapons=this.configWeapons(),s.combatMods=this.configCombatMods()),"weapon"===t&&(s.skills=await this.getCompendiumCombatSkills(!0),s.actorTypes=this.getActorTypes(),s.locations=this.configLocations(!1,e.systemData.actorType),s.weapons=this.configWeapons(),s.weaponLevels=this.configWeaponsLevels(),s.armors=this.configArmors(),s.characteristics=this.getCharacteristics(e)),"armor"===t&&(s.skills=await this.getSimpleCompendiumSkills(!0),s.actorTypes=this.getActorTypes(),s.locations=this.configLocations(!1,e.systemData.actorType),s.armors=this.configArmors(),s.characteristics=this.getCharacteristics(e)),"spell"===t&&(s.rules=this.configRules(),s.magic=this.configMagic()),"book"===t&&(s.rules=this.configRules(),s.magic=this.configMagic(),s.languages=await this.getCompendiumLanguages(!1),s.spells=await this.getSpellsFromEverywhere()),"loreSociety"===t&&(s.rules=this.configRules()),"loreKingdom"===t&&(s.rules=this.configRules(),s.nations=await this.getCompendiumLore("loreNation",e.systemData.control.rules,!1)),"loreNation"===t&&(s.rules=this.configRules(),s.societies=await this.getCompendiumLore("loreSociety",e.systemData.control.rules,!1),s.stratums=await this.getCompendiumLore("loreStratum",e.systemData.control.rules,!1),s.positions=await this.getCompendiumLore("lorePosition",e.systemData.control.rules,!1),s.professions=await this.getCompendiumLore("loreProfession",e.systemData.control.rules,!1),s.languages=await this.getCompendiumLanguages(!1)),"loreStratum"===t&&(s.rules=this.configRules(),s.societies=await this.getCompendiumLore("loreSociety",e.systemData.control.rules,!1)),"lorePosition"===t&&(s.rules=this.configRules(),s.societies=await this.getCompendiumLore("loreSociety",e.systemData.control.rules,!1),s.stratums=await this.getCompendiumLore("loreStratum",e.systemData.control.rules,!1)),"loreProfession"===t&&(s.rules=this.configRules(),s.societies=await this.getCompendiumLore("loreSociety",e.systemData.control.rules,!1),s.stratums=await this.getCompendiumLore("loreStratum",e.systemData.control.rules,!1),s.characteristics=this.getAllCharacteristics(),s.skills=await this.getSimpleCompendiumSkills(!1),s.weaponLevels=this.configWeaponsLevels(),s.armors=this.configArmors()),s}static getAllCharacteristics(){return[...this.getCharacteristics(),...this.getSecondaries()]}static getCharacteristics(e){let t=[];for(var s in game.template.Actor.templates.base.characteristics)t.push({id:s,name:game.i18n.localize("characteristics."+s)});return t}static getSecondaries(){let e=[];for(var t in game.template.Actor.templates.base.secondaries)e.push({id:t,name:game.i18n.localize("characteristics."+t)});return e}static getSocialMods(){let t=[];for(var s in game.template.Actor.templates.base.attributes.social)t.push({id:s,name:game.i18n.localize("common.social"+e.capitalize(s))});return t}static getMoneyTypes(){let e=[];for(var t in game.template.Actor.templates.base.money)e.push({id:t,name:game.i18n.localize("common."+t)});return e}static async getCompendiumSkills(e){let t=await this.getFromCompendium("skills",e=!!e&&e);return t.map(e=>e.controlKey=e.system.control.key),t}static async getCompendiumCombatSkills(e){let t=[],s=await this.getFromCompendium("skills",e=!!e&&e);return(s=s.filter(e=>e.system.extend?.combat)).map(e=>e.controlKey=e.system.control.key),s.map(e=>{t.push({id:e.system.control.key,name:e.name,name2:e.name+" ("+game.i18n.localize("characteristics."+e.system.extend.characteristic)+")"})}),t}static async getSimpleCompendiumSkills(e){let t=[];return(await this.getFromCompendium("skills",e)).map(e=>{t.push({id:e.system.control.key,name:e.name,name2:e.name+" ("+game.i18n.localize("characteristics."+e.system.extend?.characteristic)+")"})}),t}static async getParentSkills(t,s){let i=[{id:"",key:"",name:""}];if(t){let a=await game.packs.get(t),o=await a.getDocuments();o.filter(e=>"skill"===e.type&&""===e.system.extend.parent).map(e=>{i.find(t=>t.key===e.system.control.key)||i.push({id:e.id,key:e.system.control.key,name:e.name})})}else s?Array.from(s.items).filter(e=>"skill"===e.type&&""===e.system.extend.parent).map(e=>{i.find(t=>t.key===e.system.control.key)||i.push({id:e.id,key:e.system.control.key,name:e.name})}):Array.from(game.items).filter(e=>"skill"===e.type&&""===e.system.extend.parent).map(e=>{i.find(t=>t.key===e.system.control.key)||i.push({id:e.id,key:e.system.control.key,name:e.name})});return i.sort(e.byName),i}static async getCompendiumLanguages(t){let s=await this.getFromCompendium("skills",t=!!t&&t);return(s=s.filter(e=>e.system.extend.language)).sort(e.byName),s.forEach(e=>{e.controlKey=e.system.control.key}),s}static async getSpellsFromEverywhere(){let t=[],s=Array.from(game.packs).filter(e=>Array.from(e.index).find(e=>"spell"===e.type));if(0===s.length)return t;for(let i of s){let a=await game.packs.get(i.metadata.id);if(a)(await a.getDocuments()).filter(e=>"spell"===e.type).map(e=>{t.push({pack:i.metadata.id,id:e.id,name:e.name})})}return t.sort(e.byName),t}static async getFromCompendium(t,s,i){let a=await game.packs.get(game.system.id+"."+t);if(!a)return[];let o=i?(await a.getDocuments()).filter(e=>e.type===i):await a.getDocuments();return 0===o.length?[]:(s&&o.unshift({id:"",name:"",system:{control:{key:""}}}),o.sort(e.byName),o.forEach(e=>{e.controlKey=e.system.control.key}),o)}static async getCompendiumLore(e,t,s){let i=await this.getFromCompendium("context",s=!!s&&s,e);return t&&(i=i.filter(e=>e.system.control.rules===t)),"trait"===e&&(i=i.filter(e=>!e.system.extend.sequel)),i.map(e=>e.controlKey=e.system.control.key),i}static configLocationsEntities(s=!1){let i=[];for(var a in t.locations){let o=t.locations[a];i.push({key:a,...o,label:game.i18n.localize(o.label)})}return s&&i.unshift({key:"",label:""}),i.sort(e.byName),i}static getActorTypes(t=!1){let s=game.template.Actor.types,i=[];return s.map(e=>{i.push({key:e,label:game.i18n.localize("entity."+e)})}),i.sort(e.byName),i}static configLocations(s=!1,i="human"){let a=[];for(var o in t.locations[i].locations){let l=t.locations[i].locations[o];a.push({key:o,...l,label:game.i18n.localize(l.label)})}return s&&a.unshift({key:"",label:""}),a.sort(e.byName),a}static configWeapons(){let s={};for(var i in t.weapons){for(var a in s[i]||(s[i]=[]),t.weapons[i]){let o=t.weapons[i][a];s[i].push({key:a,...o,label:game.i18n.localize(o.label)})}s[i].sort(e.byLevel)}return s}static configWeaponsLevels(){let s=[];for(var i in t.weaponLevels){let a=t.weaponLevels[i];s.push({key:i,...a,label:game.i18n.localize(a.label)})}return s.sort(e.byLevel),s}static configArmors(){let s={};for(var i in t.armors){for(var a in s[i]||(s[i]=[]),t.armors[i]){let o=t.armors[i][a];s[i].push({key:a,...o,label:game.i18n.localize(o.label)})}s[i].sort(e.byLevel)}return s}static configMagic(){let s={};for(var i in t.magic){for(var a in s[i]||(s[i]=[]),t.magic[i]){let o=t.magic[i][a];s[i].push({key:a,...o,label:game.i18n.localize(o.label)})}s[i].sort(e.byName)}return s}static configCombatMods(){let e=[];for(var s in t.combatModsGroups){let i=t.combatModsGroups[s];e.push({key:s,...i,label:game.i18n.localize(i.label),items:t.combatMods.filter(e=>e.group===s)})}return e.map(e=>e.items.map(e=>{e.label=game.i18n.localize(e.label),e.descr=game.i18n.localize(e.descr),e.applyAttack=""!==e.attack,e.applyDefense=""!==e.defense})),e}static configRules(){let e=[];for(var s in t.rules){let i=t.rules[s];e.push({...i,key:s,name:game.i18n.localize("common."+s)})}return e}static configModes(){let e=[];for(var s in t.modes){let i=t.modes[s];e.push({...i,key:s,name:game.i18n.localize(i.label)})}return e}static async checkKey(e){let t=e.systemData.control.key;if(t=(t=t.toLowerCase()).replaceAll(" ","_"),e.systemData.control.key=t,e.document.pack){let s=await game.packs.get(e.document.pack),i=await s.getDocuments();e.systemData.control.repeated=void 0!==i.find(s=>s.id!==e.document.id&&s.type===e.document.type&&s.system.control.key===t)}else e.document.parent&&e.document.parent?.type==="human"?e.systemData.control.repeated=void 0!==e.document.parent.items.find(s=>s.id!==e.document.id&&s.type===e.document.type&&s.system.control.key===t):e.systemData.control.repeated=void 0!==Array.from(game.items).find(s=>s.id!==e.document.id&&s.type===e.document.type&&s.system.control.key===t)}}