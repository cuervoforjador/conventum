import{helperBackend}from"./helperBackend.js";export class helperUtils{static getChar(e,t){try{if(void 0!==e.characteristics[t])return Number(e.characteristics[t].value)+Number(this.checkMod(e.characteristics[t].mod));if(void 0!==e.secondaries[t])return Number(e.secondaries[t].value)+Number(this.checkMod(e.secondaries[t].mod));if(void 0!==e.attributes[t])return Number(e.attributes[t].value)+Number(this.checkMod(e.attributes[t].mod))}catch(s){return 0}}static getActorFromSheetId(e){return e.split("-Token-").length>1?Array.from(game.scenes.active.tokens).find(t=>t.getActor()?.sheet.id===e).getActor():Array.from(game.actors).find(t=>t.sheet.id===e)}static allActors(){let e=[];return Array.from(game.scenes.active.tokens).filter(e=>e.actor?.isToken).forEach(t=>{e.push(t.getActor())}),[...Array.from(game.actors),...e].sort(helperUtils.byName)}static getActor(e,t){return t&&""!==t&&"undefined"!==t?game.scenes.active.tokens.get(t).actor:game.actors.get(e)}static getRules(){return game.settings.get(game.system.id,"rules")}static checkMod(e){try{if(isNaN(Number(e)))return"+0";return Number(e)>=0?"+"+Number(e).toString():"-"+Math.abs(e).toString()}catch(t){return"+0"}}static checkDiceMod(sValue){let sValue0=sValue.toUpperCase().replaceAll("D","*");try{if(isNaN(Number(eval(sValue0))))return"+0";return helperUtils.checkMod(sValue)}catch(e){return"+0"}}static sumMods(e){let t=0;try{e.map(e=>{t+=Number(e)})}catch(s){return"+0"}return this.checkMod(t)}static checkMult(e){try{if(isNaN(Number(e))||0===Number(e))return 1;return Number(e)}catch(t){return 1}}static calcValueTotal(e){if(!e)return 0;try{let t=Number(e.value);return e.modBase&&(t+=Number(helperUtils.checkMod(e.modBase))),e.mod&&(t+=Number(helperUtils.checkMod(e.mod))),e.mult&&(t*=Number(helperUtils.checkMult(e.mult))),Math.ceil(t)}catch(s){return 0}}static calcAlphaValueTotal(e){if(!e)return"";try{let t=e.value?e.value:e.base;if(!t)return"";return 0!==Number(helperUtils.checkMod(e.mod))&&(t=t+" "+e.mod),1!==Number(helperUtils.checkMult(e.mult))&&(t="("+t+")*"+e.mult.toString()),t}catch(s){return""}}static calcValueFinal(e){let t=0;try{for(var s in t=Number(e.base),e.mods)t+=Number(e.mods[s]);t+=Number(e.custoMod)}catch(l){return 0}return isNaN(t)?0:t}static lookForSkill(e){let t="";return e=e.toLowerCase(),["#wpskill","#wpskill2","#skill_"].map(s=>{let l=this.exprCutting(e.substr(this.exprLocations(s,e)[0]));"#wpskill"===l.split("_")[0]&&(t="wpskill"),"#wpskill2"===l.split("_")[0]&&(t="wpskill2"),"#skill"===l.split("_")[0]&&(t=l.split("_")[1])}),t}static evalExpression(e,t=!1,s,l){t=!!t&&t;let r=["#wpskill","#wpskill2","#wpsize","#wpsize2","#skill_","#char_"];e=e.toLowerCase();let i="";for(var a of r){let c=this.exprLocations(a,e);if(0===c.length)continue;let n=this.exprCutting(e.substr(this.exprLocations(a,e)[0]));e=t?helperUtils.replaceTagTitle(e,n,s,l):helperUtils.replaceTagExpression(e,n,s,l)}try{i=t?e:Math.ceil(helperUtils.eval(e))}catch(o){i=""}return i}static exprLocations(e,t){for(var s=[],l=-1;(l=t.indexOf(e,l+1))>=0;)s.push(l);return s}static exprCutting(e){return e.split(" ")[0].split("+")[0].split("-")[0].split("*")[0].split("/")[0].split("(")[0].split(")")[0].split("[")[0].split("]")[0].split("{")[0].split("}")[0]}static eval(sExpression){let rExpression=sExpression.replaceAll("%","");rExpression=(rExpression=rExpression.replaceAll("[","(")).replaceAll("]",")");try{return eval(rExpression)}catch(e){return""}}static replaceTagExpression(e,t,s,l){let r="0",i=null;try{switch(t.split("_")[0]){case"#wpskill":r=helperUtils.calcValueTotal(s.system.skills[l?.system.skillkey]);break;case"#wpsize":r=CONFIG.ExtendConfig.weapons.weaponSizes[l?.system.size]?.mult;break;case"#wpskill2":i=""!==s.system.control.combat.weapon.second?s.items.get(s.system.control.combat.weapon.second):null,r=helperUtils.calcValueTotal(s.system.skills[i?.system.skillkey]);break;case"#wpsize2":r=CONFIG.ExtendConfig.weapons.weaponSizes[(i=""!==s.system.control.combat.weapon.second?s.items.get(s.system.control.combat.weapon.second):null)?.system.size]?.mult;break;case"#skill":let a=t.split("_")[1];r=skill?helperUtils.calcValueTotal(s.system.skills[a]):"0";break;case"#char":let c=t.split("_")[1];r=helperUtils.getChar(s.system,c)}}catch(n){r=""}return r=r||"",e.replaceAll(t,r.toString())}static replaceTagTitle(e,t,s,l){let r="",i=null;try{switch(t.split("_")[0]){case"#wpskill":r=s.items.find(e=>"skill"===e.type&&e.system.control.key===l?.system.skillkey)?.name;break;case"#wpsize":r=game.i18n.localize(CONFIG.ExtendConfig.weapons.weaponSizes[l?.system.size]?.label);break;case"#wpskill2":i=""!==s.system.control.combat.weapon.second?s.items.get(s.system.control.combat.weapon.second):null;r=s.items.find(e=>"skill"===e.type&&e.system.control.key===i?.system.skillkey)?.name;break;case"#wpsize2":i=""!==s.system.control.combat.weapon.second?s.items.get(s.system.control.combat.weapon.second):null,r=game.i18n.localize(CONFIG.ExtendConfig.weapons.weaponSizes[i?.system.size]?.label);break;case"#skill":let a=t.split("_")[1],c=s.items.find(e=>"skill"===e.type&&e.system.control.key===a);r=c?.name;break;case"#char":let n=t.split("_")[1];r=game.i18n.localize("characteristics."+n)}}catch(o){r=""}return r=r||"",e.replaceAll(t,r.toString())}static evalMaxExpression(sExpression){let s2=sExpression.toUpperCase().replaceAll("D","*1*");try{let nR;return Number(eval(s2)).toString()}catch(e){return sExpression}}static assetsPath(){return"/systems/"+game.system.id+"/assets"}static dialog(e,t,s="_info"){let l=new Dialog({title:e,content:t,buttons:{}});l.options.classes=["dialog",s],l.render(!0)}static byName(e,t){let s=e.hasOwnProperty("name")?"name":e.hasOwnProperty("label")?"label":null;if(s)return e&&t&&e[s]&&t[s]?l(e[s].toUpperCase())<l(t[s].toUpperCase())?-1:l(e[s].toUpperCase())>l(t[s].toUpperCase())?1:0:0;return e&&t?l(e.toUpperCase())<l(t.toUpperCase())?-1:l(e.toUpperCase())>l(t.toUpperCase())?1:0:0;function l(e){return e.replaceAll("\xc1","A").replaceAll("\xc9","E").replaceAll("\xcd","I").replaceAll("\xd3","O").replaceAll("\xda","U")}}static byLevel(e,t){return e.level<t.level?-1:e.level>t.level?1:0}static byIndex(e,t){return e.index<t.index?-1:e.index>t.index?1:0}static byInitiative(e,t){return t.initiative-e.initiative}static generateID(){return Math.random().toString(20).substring(2,18)}static capitalize(e){return e[0].toUpperCase()+e.slice(1)}static clearTags(e){let t="";return e.split(">").map(e=>{t+=e.split("<")[0]}),t}static isActorPathProperty(e){let t=e.replaceAll("system.",""),s=game.template.Actor.templates.base;try{if(t.split(".").map(e=>{s=s[e]}),!s||void 0===s)return!1;return!0}catch(l){return!1}}static getActorProperty(e,t){let s=e.split("system").length>1?t:t.system;try{if(e.split(".").map(e=>{s=s[e]}),!s||void 0===s)return;return s}catch(l){return}}static getTitleFromPath(e,t){let s=e.replaceAll(".value","").replaceAll(".mod","").replaceAll(".min","").replaceAll(".max","").replaceAll("system.","");try{if("characteristics"===s.split(".")[0]||"secondaries"===s.split(".")[0])return game.i18n.localize("characteristics."+s.split(".")[1]);if("attributes"===s.split(".")[0])return game.i18n.localize("attributes."+s.split(".")[1]);if("skills"===s.split(".")[0])return t.items.find(e=>"skill"===e.type&&e.system.control.key===s.split(".")[1])?.name;if("money"===s.split(".")[0])return game.i18n.localize("common.money")}catch(l){return""}}}