import{helperBackend as s}from"../helpers/helperBackend.js";import{helperSheets as t}from"../helpers/helperSheets.js";import{helperUtils as e}from"../helpers/helperUtils.js";import{helperMagic as l}from"../helpers/helperMagic.js";export class backMagic{_actor=null;_sheet=null;_context=null;_systemData=null;system={key:"s1",s1:!0,s2:!1};configMagic={};books=[];noBooks=!0;spells=[];noSpells=!0;properties={conc:0,concMax:0,concPer:0,faith:0,faithMax:0,faithPer:0,theology:0,rr:0,irr:0};spell={selected:!1,spellId:"",cell:"",spell:null,roll:{base:0,baseRit:0,value:0,bonus:0,penal:0,armorMod:"+0",custoMod:"+0",modSpell:"+0",totalMod:"+0",armorApply:!1,armorModID:"",armorName:"",able:!0,title:game.i18n.localize("characteristics.irr")},info:{vis:!1,ordo:!1,system:"s1",s1:!0,s2:!1,level:"",levelTxt:"",shape:"",nature:"",origin:"",cost:0,costUnit:"",penal:0,rrRoll:!1,needPreparation:!1,preparationValue:0,preparationTotal:0,preparationUnit:"common.days",preparationComp:!1},properties:{conc:0,exper:0,faith:0,mod:"+0",skillMin:0,study:0},cellProperties:{itemId:"",prepTime:0,prepUnit:"common.days",prepValue:0,roll:!1,rolled:!1,success:!1,days:0},preparation:{dose:0,showDose:!1,maxSameTime:0,alchemyMax:0,alchemyMin:0,roll:"0",unit:"common.days"}};ordos=[{level:1},{level:2},{level:3},{level:4},{level:5},{level:6}];study={spell:null,ordoLevel:{},ordoName:"",vis:!1,ordo:!1,spellProp:{conc:0,exper:0,faith:0,mod:"+0",skillMin:0,study:0},book:null,fromBook:!1,showReadButton:!1,language:0,languageKey:"",languageTxt:"",showChannelButton:!1,experience:0,showLearnProgress:!1,learnDaysMax:0,learnMonthsMax:0,learnDays:0,learnMonths:0,learnPercent:0,showTeacher:!1,teacher:"",teachPercent:0,showMemory:!1,irrRoll:0,rrRoll:0};template={rows:[{cells:[{double:!1,img:e.assetsPath()+"/misc/jug.svg",class:"_potion",type:"potion",index:"potion1"},{double:!1,img:e.assetsPath()+"/misc/jug.svg",class:"_potion",type:"potion",index:"potion2"},{double:!1,img:e.assetsPath()+"/misc/jug.svg",class:"_potion",type:"potion",index:"potion3"},]},{cells:[{double:!1,img:e.assetsPath()+"/misc/powder.svg",class:"_unguent",type:"unguent",index:"unguent1"},{double:!1,img:e.assetsPath()+"/misc/powder.svg",class:"_unguent",type:"unguent",index:"unguent2"},{double:!1,img:e.assetsPath()+"/misc/powder.svg",class:"_unguent",type:"unguent",index:"unguent3"},]},{cells:[{double:!1,img:e.assetsPath()+"/misc/pentagram-rose.svg",class:"_talisman",type:"talisman",index:"talisman"},{double:!0,img:e.assetsPath()+"/misc/enlightenment.svg",class:"_spell",type:"spell",index:"spell"}]}]};constructor(s,t,e){this._actor=s,this._sheet=e,this._context=t,this._systemData=t.systemData}async init(){try{this._initSystem(),this._initProperties(),this._initOrdos(),this._initBooks(),this._spells(),this._template(),this._studying(),this._selectSpell(),this._calcRoll(),this._calcArmorMod(),this._calcTotalMod(),this._calcRollFinal(),this._calcFaithAble(),this._context.backMagic=this}catch(s){ui.notifications.error(s)}}_initSystem(){this.system.key=CONFIG.ExtendConfig.rules[this._systemData.control.rules].magicSystem,this.system.s1="s1"===this.system.key,this.system.s2="s2"===this.system.key,this.configMagic=s.configMagic()}_initProperties(){this.properties={...this.properties,conc:e.calcValueTotal(this._systemData.secondaries.conc),concMax:this._systemData.secondaries.conc.max,faith:e.calcValueTotal(this._systemData.secondaries.faith),faithMax:this._systemData.secondaries.faith.max,theology:e.calcValueTotal(this._systemData.skills.theology),experience:e.calcValueTotal(this._systemData.secondaries.exper),rr:e.calcValueTotal(this._systemData.secondaries.rr),irr:e.calcValueTotal(this._systemData.secondaries.irr)},this.properties.concPer=Math.ceil(this.properties.conc/this.properties.concMax*100),this.properties.faithPer=Math.ceil(this.properties.faith/this.properties.faithMax*100),this.properties.concPer=this.properties.concPer>100?100:this.properties.concPer<0?0:this.properties.concPer,this.properties.faithPer=this.properties.faithPer>100?100:this.properties.faithPer<0?0:this.properties.faithPer}_initOrdos(){for(var s=0;s<this.ordos.length;s++){let t=this.ordos[s];t.label=game.i18n.localize("spell.ordo"+t.level),this.ordos[s]={...t,...l.ordoLevel(this._actor,t.level)},this.ordos[s].img=e.assetsPath()+this.ordos[s].img,this.ordos[s].learned=this._actor.system.magic.ordos["o"+t.level]}}_initBooks(){this._actor.items.filter(s=>"book"===s.type).map(s=>{let t=this._actor.items.filter(t=>"spell"===t.type&&t.system.study.fromBook&&t.system.study.book===s.id),l=this._actor.items.find(t=>"skill"===t.type&&t.system.control.key===s.system.language);this.books.push({language:l?l.name:game.i18n.localize("common.unknow"),languageSkill:e.calcValueTotal(this._systemData.skills[s.system.language]),teach:s.system.teach,book:s,spells:t})}),this.noBooks=0===this.books.length}_spells(){this.spells=this._actor.items.filter(s=>"spell"===s.type),this.spells.sort(e.byName),this.noSpells=0===this.spells.length}_template(){for(let s of this.template.rows)for(let t of s.cells){t.prepareTxt=game.i18n.localize("common.prepare"+t.type);let e=this._systemData.magic.template[t.index];t.properties=e,t.showPrepare=!e.itemId||""===e.itemId,t.showPrepare?t.class+=" _still":(t.spell=this._actor.items.get(e.itemId),t.inPreparation=0!==e.prepTime,t.finish=e.prepTime===e.prepValue)}}_studying(){if(!this._systemData.magic.study.learning||""===this._systemData.magic.study.spellId&&""===this._systemData.magic.study.ordoId){this._systemData.magic.study={...this._systemData.magic.study,learning:!1,spellId:"",months:0,unit:"common.months",read:!1,channeled:!1,learned:!1,learnedPercent:0,teached:!1,teachPercent:0,memorized:!1};return}if(this.study.spell=this._actor.items.get(this._systemData.magic.study.spellId),this.study.ordoLevel=CONFIG.ExtendConfig.magic.spellsORDO["ordo"+this._systemData.magic.study.ordoId]?.["s"+this._systemData.magic.system],!this.study.spell&&""===this._systemData.magic.study.ordoId||!this.study.ordoLevel&&""===this._systemData.magic.study.spellId){this._systemData.magic.study.learning="",this._systemData.magic.study.spellId="",this._systemData.magic.study.ordoId="";return}if(this.study.vis=!!this.study.spell&&this.study.spell.system.type.vis,this.study.ordo=!this.study.spell&&!!this._systemData.magic.study.ordoId,this.study.ordoName=this.study.ordo?game.i18n.localize("spell.ordo"+this._systemData.magic.study.ordoId):"",this.study.spellProp=this.study.vis?{...this.study.spellProp,...t.spell_prop(this.study.spell?.system)}:this.study.ordoLevel,this.study.experience=this.study.spellProp.exper,this.study.fromBook=this.study.spell?.system.study.fromBook,this.study.spell?.system.study.fromBook?this.study.book=this._actor.items.get(this.study.spell.system.study.book):this._systemData.magic.study.read=!0,!this._systemData.magic.study.read){this._systemData.magic.study={...this._systemData.magic.study,read:!1,learned:!1,teached:!1,read:!1},this.study.showReadButton=!0;let s=this.books.find(s=>s.book.id===this.study.book?.id);this.study.language=s.languageSkill,this.study.languageKey=this.study.book?.system.language,this.study.languageTxt=s.language}!this.study.ordo||this._systemData.magic.study.channeled||this._systemData.magic.study.learned||this._systemData.magic.study.teached||(this.study.showChannelButton=!0),this.study.learnDaysMax=this.study.vis?7*this.study.spellProp.study:0,this.study.learnMonthsMax=this.study.ordo?this.study.spellProp.study:0,this.study.learnDays=this._systemData.magic.study.learnedDays,this.study.learnMonths=this._systemData.magic.study.learnedMonths,this.study.learnDays>this.study.learnDaysMax&&(this.study.learnDays=this.study.learnDaysMax),this.study.learnMonths>this.study.learnMonthsMax&&(this.study.learnMonths=this.study.learnMonthsMax),this.study.learnPercent=this.study.vis?Math.ceil(this.study.learnDays/this.study.learnDaysMax*100):Math.ceil(this.study.learnMonths/this.study.learnMonthsMax*100),this.study.learnPercent>100&&(this.study.learnPercent=100),this._systemData.magic.study.learned=this.study.vis?this._systemData.magic.study.learned?this._systemData.magic.study.learned:this.study.learnDays===this.study.learnDaysMax:this._systemData.magic.study.learned?this._systemData.magic.study.learned:this.study.learnMonths===this.study.learnMonthsMax,this._systemData.magic.study.read&&!this._systemData.magic.study.learned&&(this.study.showLearnProgress=!this.study.ordo||this._systemData.magic.study.channeled),this.study.teacher=this.study.fromBook?game.i18n.localize("common.grimoire")+" ("+this.study.book.name+")":game.i18n.localize("common.teacher"),this._systemData.magic.study.teachPercent=this.study.fromBook?this.study.book?.system.teach:this._systemData.magic.study.teachPercent,this.study.teachPercent=this._systemData.magic.study.teachPercent,this._systemData.magic.study.read&&this._systemData.magic.study.learned&&!this._systemData.magic.study.teached&&(this.study.showTeacher=!0),this.study.irrRoll=Number(this.properties.irr)+Number(this.study.spellProp.mod),this.study.rrRoll=Number(this.properties.rr)+Number(this.study.spellProp.mod),(this.study.vis&&this._systemData.magic.study.read&&this._systemData.magic.study.learned&&this._systemData.magic.study.teached||!this.study.vis&&this._systemData.magic.study.read&&this._systemData.magic.study.learned)&&(this.study.showMemory=!0)}_selectSpell(){let s=this._actor.items.get(this._systemData.magic.template.spellId);if(!s){this._systemData.magic.template.spellId="",this._systemData.magic.template.selected="";return}this.spell.selected=!0,this.spell.spell=s,this.spell.cell=this._systemData.magic.template.selected,this.spell.spellId=this._systemData.magic.template.spellId;let t=l.spellPreparation(s);this.spell.properties={...this.spell.properties,...l.spellProperty(s)},t&&(this.spell.preparation.dose=t.dose,this.spell.preparation.showDose=t.dose>0&&"talisman"!==this.spell.cell&&"spell"!==this.spell.cell,this.spell.preparation.maxSameTime=t.maxSameTime),this.spell.preparation={...this.spell.preparation,...l.spellAlchemyPreparation(s,this._actor)},this.spell.cellProperties={...this.spell.cellProperties,...this._systemData.magic.template[this.spell.cell]},this.spell.info={...this.spell.info,vis:s.system.type.vis,ordo:s.system.type.ordo,system:"s"+s.system.type.system,s1:1===Number(s.system.type.system),s2:2===Number(s.system.type.system),level:s.system.level,levelTxt:s.system.type.vis?game.i18n.localize("spell.vis"+s.system.level):s.system.type.ordo?game.i18n.localize("spell.ordo"+s.system.level):"",shape:game.i18n.localize(CONFIG.ExtendConfig.magic.shape[s.system.properties.shape]?.label),nature:game.i18n.localize(CONFIG.ExtendConfig.magic.nature[s.system.properties.nature]?.label),origin:game.i18n.localize(CONFIG.ExtendConfig.magic.origin[s.system.properties.origin]?.label),needPreparation:!!this.spell.cellProperties.prepTime&&0!==this.spell.cellProperties.prepTime,preparationValue:this.spell.cellProperties.prepValue,preparationTotal:this.spell.cellProperties.prepTime,preparationUnit:game.i18n.localize(this.spell.cellProperties.prepUnit),preparationComp:this.spell.cellProperties.prepValue===this.spell.cellProperties.prepTime,cost:s.system.type.vis?this.spell.properties.conc:this.spell.properties.faith,costUnit:s.system.type.vis?game.i18n.localize("characteristics.conc"):game.i18n.localize("characteristics.faith"),penal:this.spell.properties.mod,rrRoll:s.system.properties.rrRoll}}_calcRoll(){this.spell.roll.base=e.calcValueTotal(this._systemData.secondaries.irr),this.spell.roll.baseRit=e.calcValueTotal(this._systemData.secondaries.rr),this.spell.selected&&(this.spell.roll.modSpell=this.spell.properties.mod)}_calcArmorMod(){let s=l.calcArmorMod(this._actor);this.spell.roll.armorMod=s.penal,this.spell.roll.armorModID=s.itemID,this.spell.roll.armorApply=""!==this.spell.roll.armorModID,this.spell.roll.armorName=this.spell.roll.armorApply?this._actor.items.get(this.spell.roll.armorModID)?.name:""}_calcTotalMod(){this.spell.spell&&(this._systemData.control.combat.spell.custoMod=e.checkMod(this._systemData.control.combat.spell.custoMod),this._systemData.control.combat.spell.custoRitMod=e.checkMod(this._systemData.control.combat.spell.custoRitMod),this.spell.roll.custoMod=this.spell.spell.system.type.vis?this._systemData.control.combat.spell.custoMod:this._systemData.control.combat.spell.custoRitMod,this.spell.roll.totalMod=e.sumMods([this.spell.roll.armorMod,this.spell.roll.custoMod,this.spell.roll.modSpell]))}_calcRollFinal(){this.spell.spell&&(this.spell.roll.value=this.spell.spell.system.type.vis?this.spell.roll.base+Number(this.spell.roll.totalMod):this.spell.roll.baseRit+Number(this.spell.roll.totalMod),this.spell.roll.title=this.spell.spell.system.type.vis?game.i18n.localize("characteristics.irr"):game.i18n.localize("characteristics.rr"))}_calcFaithAble(){this.spell.spell&&!this.spell.spell.system.type.vis&&(this.properties.faith<this.spell.info.cost&&(this.spell.roll.able=!1),this.spell.spell.system.properties.grace&&this.properties.faith<this._systemData.secondaries.faith.max&&(this.spell.roll.able=!1))}_getItemsByType(s){let t=this._actor.items.filter(t=>t.type===s);return t.sort(e.byName),t}_sortByName(s){s.sort(e.byName)}}