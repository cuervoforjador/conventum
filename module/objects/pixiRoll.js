import{pixiBase as t}from"./pixiBase.js";import{pixiHelper as i}from"./pixiHelper.js";import{helperUtils as e}from"../helpers/helperUtils.js";export class pixiRoll extends t{_context={title:"",actor:null,item:null,roll:null};_config={smokeColor:"#AA5555",smokeSpeed:.5};_center={x:this._canvas.width()/2,y:this._canvas.height()/2};_layers={front:null,back:null};_ring={formula:"1D100",value:0,valueLabel:"",valueText:"",base:0,baseText:"",bonus:0,bonusText:"",penal:0,penalText:"",extra:0,extraText:"",extraTextTop:!1};_initial={value:0,base:0,bonus:0,penal:0,extra:0};_mod={apply:!1,text:"",value:"+0"};_noHelps=!1;_textures=[{path:"pixiBase/portraitFrame.png",prop:"portraitFrame"},{path:"pixiBase/menuCircle.png",prop:"menuCircle"},{path:"pixiBase/seal.png",prop:"seal"},{path:"pixiBase/x.png",prop:"sealX"},{path:"pixiBase/frameLevels.png",prop:"frameLevels"},{path:"pixiBase/frameBox.png",prop:"frameBox"},{path:"pixiBase/frameExtra.png",prop:"frameExtra"},{path:"pixiBase/buttonMods.png",prop:"buttonMods"},{path:"pixiBase/mod+60.png",prop:"mod+60"},{path:"pixiBase/mod+40.png",prop:"mod+40"},{path:"pixiBase/mod+20.png",prop:"mod+20"},{path:"pixiBase/mod+0.png",prop:"mod+0"},{path:"pixiBase/mod-20.png",prop:"mod-20"},{path:"pixiBase/mod-40.png",prop:"mod-40"},{path:"pixiBase/mod-60.png",prop:"mod-60"},{path:"pixiBase/mod-80.png",prop:"mod-80"},{path:"pixiBase/mod-100.png",prop:"mod-100"},{path:"pixiBase/modFrame.png",prop:"modFrame"},{path:"pixiBase/back.png",prop:"backOptions"},{path:"pixiBase/ringCriticalSuccess.png",prop:"ringCriticalSuccess"},{path:"pixiBase/ringSuccess.png",prop:"ringSuccess"},{path:"pixiBase/ringFailure.png",prop:"ringFailure"},{path:"pixiBase/ringCriticalFailure.png",prop:"ringCriticalFailure"},{path:"pixiBase/barLuck.png",prop:"barLuck"},{path:"pixiBase/barLuckBack.png",prop:"barLuckBack"}];_load={};_eventRadius=0;_levelMod="";_appliedLuck=!1;init(t){try{this._config={...this._config,...t.config},this._context={...this._context,...t.context},this._ring={...this._ring,...t.rollRing},t.noHelps&&(this._noHelps=t.noHelps),this._ring.value=Number(this._ring.value),this._ring.base=Number(this._ring.base),this._ring.bonus=Number(this._ring.bonus),this._ring.penal=Number(this._ring.penal),this._ring.extra=Number(this._ring.extra),this._initial.value=this._ring.value,this._initial.base=this._ring.base,this._initial.bonus=this._ring.bonus,this._initial.penal=this._ring.penal,this._initial.extra=this._ring.extra,this._ring.valueLabel=this._ring.rollformula?this._ring.formula:this._ring.value}catch(i){ui.notifications.error(i)}}async draw(){await super.draw(),await this._loadTextures(),this._drawLayers(),this._drawSmoke(),this._drawActorPortrait(),this._drawTextNotes(),this._drawRollRing(),this._drawButtonMods(),this._drawTextHeader(),this._drawLuck(),this._drawModLevel()}async _loadTextures(){for(var t of this._textures)this._load[t.prop]=PIXI.Texture.from(this._assetsPath+t.path,{resourceOptions:{autoLoad:!1}}),await this._load[t.prop].baseTexture.resource.load()}_drawLayers(){this._layers.back=new PIXI.Container,this._layers.front=new PIXI.Container,this.app.stage.addChild(this._layers.back),this.app.stage.addChild(this._layers.front),this._eventRadius=.32*this._canvas.height(),this._eventRegion=new PIXI.Graphics().beginFill(16777215,.01).lineStyle(0,16777215,1,1).drawCircle(this._center.x,this._center.y,this._eventRadius).endFill(),this._layers.front.addChild(this._eventRegion),this._eventRegion.interactive=!0,this._eventRegion.buttonMode=!0,this._eventRegion.defaultCursor="pointer",this._subEventRegion=new PIXI.Container,this._layers.front.addChild(this._subEventRegion)}async _drawSmoke(){let t=Math.trunc(.16*this._canvas.width());t>300&&(t=300),t<200&&(t=200),i.drawSmokeTexture(this._background,this.app._tickers,1.1*this._canvas.width(),1.1*this._canvas.height(),-(.05*this._canvas.width()),-(.05*this._canvas.height()),this._config.smokeColor,t,this._config.smokeSpeed)}async _drawActorPortrait(){if(!this._context.actor)return;let t=this._context.actor.img;this._actorPortrait=new PIXI.Container;let e=PIXI.Texture.from(t,{resourceOptions:{autoLoad:!1}});await e.baseTexture.resource.load();let s=new PIXI.Sprite(e);s.width=.45*this._canvas.width(),s.height=1.4*this._canvas.height(),s.y=-.2*this._canvas.height(),s.x=-.1*s.width;let l=new PIXI.Sprite(this._load.portraitFrame);l.width=s.width,l.height=s.height,l.x=s.x,l.y=s.y;let h=i.maskTransparent(s,l);this._actorPortrait.addChild(h),this._actorPortrait.x=0,this._actorPortrait.y=0,this._actorPortrait.filters=[new PIXI.AlphaFilter(.25)],this._background.addChild(this._actorPortrait)}_drawTextNotes(){if(!this._context.item)return;let t=this._context.item.system.description+"<p></p>";this._textNotes=new PIXI.Container;let i=.4*this._canvas.width(),e=.75*this._canvas.height(),s=new PIXI.Graphics().beginFill(16777215).drawRect(0,0,i,e-15),l=(.035*this._canvas.height()).toFixed(1),h=new PIXI.HTMLText(t,new PIXI.HTMLTextStyle({fontSize:l,lineHeight:l+1.5,fontFamily:"almendra",fill:"#FFFFFF",wordWrap:!0,wordWrapWidth:i-30}));h.x=15,h.y=15,h.height=1.2*h.height,this._textNotes.addChild(h),this._textNotes.height=e,this._textNotes.addChild(s),this._textNotes.mask=s;let r=.25*h.height,o=h.height+r>s.height?h.height-s.height+r:0;o>0&&(this.app._tickers.textNotesScroll=new PIXI.Ticker,this.app._tickers.textNotesScroll.add(t=>{h.y-=.25,h.y<=-1*o&&this.app._tickers.textNotesScroll.stop()}),this.app._tickers.textNotesScroll.start()),this._textNotes.pivot.set(.5),this._textNotes.x=.6*this._canvas.width()-10,this._textNotes.y=80,this._textNotes.filters=[new PIXI.AlphaFilter(.15)],this._background.addChild(this._textNotes)}_drawTextHeader(){this._textHeader&&(this._textHeader.destroy(),delete this._textHeader),this._textHeader=new PIXI.Container;let t=.15*this._canvas.height(),e=i.spriteText(this._context.title,"#000000","#FFFFFF",1,t,"bold","#000000",1,"almendrabold",!1);e.anchor.set(.5),e.y=this._ring.extraTextTop?this._canvas.height()-.85*e.height:.1*this._canvas.height(),e.x=.5*this._canvas.width(),e.filters=[new PIXI.AlphaFilter(.65)],i.haloShadow(e,16777215,.35,2),this._textHeader.addChild(e),this._background.addChild(this._textHeader)}_drawLuck(){if(!this._appliedLuck)return;this._textLuck&&(this._textLuck.destroy(),delete this._textLuck),this._textLuck=new PIXI.Container;let t=.15*this._canvas.height(),e=i.spriteText(game.i18n.localize("common.tryingLuck").toUpperCase(),"#FFFFFF","#000000",1,t,"bold","#000000",1,"almendrabold",!1);e.anchor.set(.5),e.y=this._canvas.height()-.85*e.height,e.x=.5*this._canvas.width(),e.filters=[new PIXI.AlphaFilter(.5)],i.haloShadow(e,16777215,.35,2),this._textLuck.addChild(e),this._background.addChild(this._textLuck)}_drawModLevel(){if(this._modLevel&&this._modLevel.destroy(),!this._mod.apply)return;this._modLevel=new PIXI.Container,this._modLevel.x=.32*this._canvas.width(),this._modLevel.y=.68*this._canvas.height();let t="mod"+this._mod.value,i=new PIXI.Sprite(this._load[t]);i.width=.075*this._canvas.width(),i.height=i.width,i.anchor.x=.5,i.anchor.y=.5,i.x=.5*i.width,i.y=.5*i.height;let e=new PIXI.Sprite(this._load.frameLevels);e.width=1.3*i.width,e.height=1.3*i.height,e.anchor.x=.5,e.anchor.y=.5,function t(){requestAnimationFrame(t),e.rotation+=.025}(),e.x=i.x,e.y=i.y,this._modLevel.addChild(e),this._modLevel.addChild(i),this._modLevel.filters=[new PIXI.AlphaFilter(.5)],this._layers.front.addChild(this._modLevel)}_drawRollRing(){this._rollRing&&(cancelAnimationFrame(this._animSprite001),this.app._tickers.rTotal&&(this.app._tickers.rTotal.stop(),this.app._tickers.rTotal.destroy(),this.app._tickers.rTotal=null,delete this.app._tickers.rTotal),this.app._tickers.rollTextAnim&&(this.app._tickers.rollTextAnim.stop(),this.app._tickers.rollTextAnim.destroy(),this.app._tickers.rollTextAnim=null,delete this.app._tickers.rollTextAnim),this._layers.back.removeChild(this._rollRing),this._layers.back.removeChild(this._rollLines),this._layers.front.removeChild(this._rollButton),this._rollText.destroy(),delete this._rollText,this._rollRing.destroy(),delete this._rollRing,this._rollLines.destroy(),delete this._rollLines,this._rollButton.destroy(),delete this._rollButton),this._rollRing=new PIXI.Container,this._rollLines=new PIXI.Container;let t=.3*this._canvas.height(),e={r0:.55*t,r1:.5*t+.165*t,r2:.5*t+.33*t,r3:.9*t},s=.75*e.r0,l=.1*Math.round(e.r3-e.r2),h=new PIXI.Sprite(this._load.menuCircle);h.width=2.4*e.r3,h.height=2.4*e.r3,h.x=0,h.y=0,h.filters=[new PIXI.AlphaFilter(.5)],h.anchor.x=.5,h.anchor.y=.5;let r=this._animSprite001;!function t(){r=requestAnimationFrame(t),h.rotation+=.001}(),this._rollRing.addChild(h),this._rollRing.addChild(i.spriteArc(e.r2,e.r3,0,2*Math.PI,l,3355443,.15)),this._rollRing.addChild(i.spriteArc(e.r1,e.r2,0,2*Math.PI,l,3355443,.15)),this._rollRing.addChild(i.spriteArc(e.r0,e.r1,0,2*Math.PI,l,3355443,.15));let o=this._ring.extra>100-this._ring.value?100-this._ring.extra:this._ring.value,a=this._ring.extra>100-this._ring.value?100:this._ring.value+this._ring.extra;if(this._ring.extra>0&&this._rollRing.addChild(i.spriteArc(e.r2,e.r3,i._toArc(o,100),i._toArc(a,100),2*l,16777215,.6)),this._ring.base>0&&(this._rollRing.addChild(i.spriteArc(e.r0,e.r1,0,i._toArc(this._ring.base,100),2*l,16768256,.65)),this._rollLines.addChild(i.spriteDegLine(0,0,e.r1-l,i._toArc(this._ring.base,100),1,0,.5))),this._ring.bonus>0&&(this._rollRing.addChild(i.spriteArc(e.r0,e.r1,i._toArc(this._ring.base,100),i._toArc(this._ring.base+this._ring.bonus,100),2*l,16777215,.65)),this._rollLines.addChild(i.spriteDegLine(0,0,e.r1-l,i._toArc(this._ring.base+this._ring.bonus,100),1,0,.25))),-Number(this._ring.penal)>0&&(this._rollRing.addChild(i.spriteArc(e.r1,.94*e.r2,i._toArc(this._ring.value,100),i._toArc(this._ring.value-Number(this._ring.penal),100),2*l,16711680,.5)),this._rollLines.addChild(i.spriteDegLine(e.r1-l,i._toArc(this._ring.base+this._ring.bonus,100),e.r2-l,i._toArc(this._ring.base+this._ring.bonus,100),1,0,.5))),this._ring.value>0){let n=i.spriteArc(e.r1,e.r2,0,i._toArc(this._ring.value,100),2*l,16768256,.9);i.haloAnimate(n,this.app._tickers,"rTotal",.1,16776960,1),this._rollRing.addChild(n),this._rollLines.addChild(i.spriteDegLine(s,i._toArc(this._ring.value,100),e.r2-l,i._toArc(this._ring.value,100),2,16768256,.9))}i.haloShadow(this._rollRing,16777130,.6,5),i.haloShadow(this._rollLines,16777215,.35,2);let d=this._ring.rollformula?.65*s:this._ring.value<100?1.65*s:1.35*s;this._rollButton=new PIXI.Graphics().beginFill(0,.01).lineStyle(1,16768256,1,1).drawCircle(0,0,s).endFill();let p=new PIXI.Sprite(this._load.frameLevels);if(p.width=1.06*this._rollButton.width,p.height=1.06*this._rollButton.height,p.x=0-1.1*s,p.y=0-1.1*s,this._rollButton.addChild(p),this._rollText=i.spriteText(this._ring.value.toString(),"#FFFFFF","#FFDD00",1,d,"bold","#FFDD00",5,"almendra",!this._ring.rollformula,1.25,"left"),this._rollText.y-=.15*d,i.haloAnimate(this._rollText,this.app._tickers,"rollTextAnim",.03,16777215,.35,10),this._rollButton.x=this._center.x,this._rollButton.y=this._center.y,this._ring.rollformula){let c=new PIXI.Graphics().beginFill(0,.75).lineStyle(1,0,1,1).drawRect(this._rollText.x-.6*this._rollText.width,this._rollText.y-.5*this._rollText.height,1.2*this._rollText.width,this._rollText.height).endFill();this._rollButton.addChild(c);let g=new PIXI.Graphics().beginFill(0,0).lineStyle(4,16768256,.5,1).drawRect(this._rollText.x-.6*this._rollText.width,this._rollText.y-.5*this._rollText.height,1.2*this._rollText.width,this._rollText.height).endFill();this._rollButton.addChild(g)}this._rollButton.addChild(this._rollText),this._layers.front.addChild(this._rollButton),this._rollButton.interactive=!0,this._rollButton.cursor="pointer",this._rollButton.buttonMode=!0;let u=i.spriteText(game.i18n.localize("common.rollDices"),"#FFFFFF","#000000",1,.16*this._rollButton.width,"","#000000",0,"almendra",!0,1);u.anchor.set(0),u.x=.15*this._rollButton.width,u.y=.15*this._rollButton.height,u.filters=[new PIXI.AlphaFilter(0)],this._rollButton.addChild(u),this._rollButton.filters=[new PIXI.AlphaFilter(.85)],this._rollButton.on("mousemove",t=>{t.preventDefault(),this._rollButton.filters=[new PIXI.AlphaFilter(1)],u.filters=[new PIXI.AlphaFilter(1)]}),this._rollButton.on("mouseout",t=>{t.preventDefault(),this._rollButton.filters=[new PIXI.AlphaFilter(.85)],u.filters=[new PIXI.AlphaFilter(0)]}),this._rollButton.on("pointerdown",t=>{t.preventDefault(),this._onLevelRingClicked=!0,this._levelMod="",this.rollIt()}),this._layers.back.addChild(this._rollRing),this._layers.back.addChild(this._rollLines),this._rollRing.x=this._center.x,this._rollRing.y=this._center.y,this._rollLines.x=this._center.x,this._rollLines.y=this._center.y}_drawButtonMods(){if(this._noHelps)return;this._buttonMods=new PIXI.Container,this._buttonMods.x=.6*this._canvas.width(),this._buttonMods.y=.2*this._canvas.height();let t=new PIXI.Sprite(this._load.buttonMods);t.width=.075*this._canvas.width(),t.height=t.width,t.anchor.x=.5,t.anchor.y=.5,t.x=.5*t.width,t.y=.5*t.height,this._buttonMods.addChild(t),function i(){requestAnimationFrame(i),t.rotation+=.01}();let e=i.spriteText(game.i18n.localize("common.applyMods"),"#FFFFFF","#000000",1,.25*t.width,"","#000000",0,"almendra",!0,1);e.anchor.set(0),e.x=.5*t.width,e.y=.6*t.height,e.filters=[new PIXI.AlphaFilter(0)],this._buttonMods.addChild(e),this._buttonMods.interactive=!0,this._buttonMods.cursor="pointer",this._buttonMods.filters=[new PIXI.AlphaFilter(.4)],this._buttonMods.on("mousemove",t=>{t.preventDefault(),this._buttonMods.filters=[new PIXI.AlphaFilter(1)],e.filters=[new PIXI.AlphaFilter(1)]}),this._buttonMods.on("mouseout",t=>{t.preventDefault(),this._buttonMods.filters=[new PIXI.AlphaFilter(.4)],e.filters=[new PIXI.AlphaFilter(0)]}),this._buttonMods.on("click",t=>{this._drawOptionsBox()}),this._layers.front.addChild(this._buttonMods)}_drawRollLevels(){this._rollLevels=new PIXI.Container;let t=[];for(var e in CONFIG.ExtendConfig.rollLevels){let s=CONFIG.ExtendConfig.rollLevels[e];0!==Number(s.mod)&&t.push({label:game.i18n.localize(s.label),mod:s.mod,value:Number(s.mod),color:s.color})}let l=.96*this._canvas.height(),h=l/(t.length+1),r=.42*h,o=1.1*r,a=1;t.sort((t,i)=>t.value>i.value),t.map(t=>{let e=(this._canvas.height()-l)/2+h*a,s=new PIXI.Graphics().beginFill(t.color,.65).lineStyle(1,t.color,1,1).drawCircle(0,e,r).endFill(),n=new PIXI.Sprite(this._load.frameLevels);n.width=1.1*s.width,n.height=1.1*s.height,n.x=0-1.15*r,n.y=e-1.15*r,s.addChild(n);let d=i.spriteText(t.mod,"#FFFFFF",t.color,1,o,"bold",t.color,5);d.anchor.set(.5),d.x=n.x+1.15*r,d.y=n.y+1*r,s.addChild(d);let p=i.spriteText(t.label.split(" (")[0],"#FFFFFF","#000000",1,.7*o,"lighter","#000000",0,"almendra",!1,.9);p.anchor.set(0),p.x=0+1.5*r,p.y=e-p.height/2;let c=new PIXI.Sprite(this._load.frameBox);c.anchor.set(0),c.width=1.2*p.width,c.height=1.1*p.height,c.x=0+1.5*r-.1*p.width,c.y=e-c.height/2,s.addChild(c),s.addChild(p),s.levelMod=t.mod,s.interactive=!0,s.cursor="pointer",s.buttonMode=!0,s.filters=[new PIXI.AlphaFilter(.8)],s.propExtend={mod:Number(t.mod)},this._onLevelRingMoving=!1,this._onLevelRingClicked=!1,s.on("mousemove",t=>{if(t.preventDefault(),this._onLevelRingMoving)return;this._onLevelRingMoving=!0,s.filters=[new PIXI.AlphaFilter(1)];let i=t.currentTarget.propExtend;i.mod>0?this._ring.bonus=this._initial.bonus+Number(i.mod):this._ring.penal=this._initial.penal+Number(i.mod),this._ring.value=this._initial.value+Number(i.mod),this._drawRollRing()}),s.on("pointerdown",t=>{t.preventDefault(),this._onLevelRingClicked=!0,this._levelMod=t.currentTarget.levelMod,this.rollIt()}),s.on("mouseout",t=>{t.preventDefault(),this._onLevelRingClicked||(this._onLevelRingMoving=!1,s.filters=[new PIXI.AlphaFilter(.8)],this._ring.bonus=this._initial.bonus,this._ring.penal=this._initial.penal,this._ring.value=this._initial.value,this._ring.base=this._initial.base,this._drawRollRing())}),s.defaultCursor="pointer",this._rollLevels.addChild(s),a++}),this._rollLevels.x=.05*this._canvas.width(),this._rollLevels.y=0,this._subEventRegion.addChild(this._rollLevels)}_drawOptionsBox(){this._optionsBox=new PIXI.Container;let t=new PIXI.Sprite(this._load.backOptions);t.width=.4*this._canvas.width(),t.height=.96*this._canvas.height(),t.x=.3*this._canvas.width(),t.y=.02*this._canvas.height(),this._optionsBox.addChild(t);let e=.056*t.height,s=i.spriteText(game.i18n.localize("common.useDiffLevels").toUpperCase(),"#000000","#FFFFFF",1,e,"bold","#000000",1,"almendrabold",!1);s.filters=[new PIXI.AlphaFilter(.6)],s.anchor.set(0),s.width=.75*t.width,s.x=t.x+.1*t.width,s.y=t.y+.3*t.height,this._optionsBox.addChild(s);let l=.055*t.height,h=i.spriteText(game.i18n.localize("common.avalLuck").toUpperCase(),"#000000","#FFFFFF",1,l,"bold","#000000",1,"almendrabold",!1);h.anchor.set(0),h.width=.65*t.width,h.x=t.x+.1*t.width,h.y=t.y+.07*t.height,h.filters=[new PIXI.AlphaFilter(.6)],this._optionsBox.addChild(h);let r=this._context.actor?.system.secondaries.luck.value,o=this._context.actor?.system.secondaries.luck.max,a=i.spriteText(r,"#000000","#FFFFFF",1,.2*t.width,"bold","#000000",1,"almendrabold",!1);a.anchor.set(1),a.width=.16*t.width,a.height=.16*t.height,a.x=t.x+.68*t.width,a.y=t.y+.25*t.height,a.filters=[new PIXI.AlphaFilter(.75)],this._optionsBox.addChild(a);let n=i.spriteText("/ "+o.toString(),"#000000","#FFFFFF",1,.11*t.width,"bold","#000000",1,"almendrabold",!1);n.anchor.set(0),n.x=t.x+.68*t.width,n.y=t.y+.15*t.height,n.filters=[new PIXI.AlphaFilter(.75)],this._optionsBox.addChild(n);let d=i.spriteText(game.i18n.localize("common.applyLuck").toUpperCase(),"#000000","#FFFFFF",1,.05*t.width,"bold","#000000",1,"almendrabold",!1);d.anchor.set(0),d.width=.38*t.width,d.x=t.x+.1*t.width,d.y=t.y+.15*t.height,d.filters=[new PIXI.AlphaFilter(.4)],this._optionsBox.addChild(d),d.interactive=!0,d.cursor="pointer",d.on("mousemove",t=>{t.preventDefault(),d.filters=[new PIXI.AlphaFilter(1)]}),d.on("mouseout",t=>{t.preventDefault(),d.filters=[new PIXI.AlphaFilter(.4)]}),d.on("click",t=>{t.preventDefault(),this._optionsBox.destroy(),this.applyLuck()});let p=[];for(var c in CONFIG.ExtendConfig.rollLevels){let g=CONFIG.ExtendConfig.rollLevels[c];p.push({label:game.i18n.localize(g.label),mod:g.mod,value:Number(g.mod),color:g.color})}let u=0;p.map(i=>{let e="mod"+i.mod;if(!this._load[e])return;let s=new PIXI.Sprite(this._load[e]),l=new PIXI.Sprite(this._load.frameLevels),h={width:t.width-.2*t.width,height:t.height-.2*t.height};s.width=Math.round(.2*h.width),s.height=Math.round(.2*h.width),l.width=1.3*s.width,l.height=1.3*s.height,l.anchor.x=.5,l.anchor.y=.5,function t(){requestAnimationFrame(t),l.rotation+=.025}();let r=1.7*s.width,o=(u+3)%3*r,a=(Math.trunc((u+3)/3)-1)*(.85*r);s.x=t.x+.18*h.width+o,s.y=t.y+h.height/5*2.5+a,s.filters=[new PIXI.AlphaFilter(.4)],l.x=s.x+s.width/2,l.y=s.y+s.height/2,l.filters=[new PIXI.AlphaFilter(.4)],s.interactive=!0,s.cursor="pointer",s.on("mousemove",t=>{t.preventDefault(),s.filters=[new PIXI.AlphaFilter(1)],l.filters=[new PIXI.AlphaFilter(1)]}),s.on("mouseout",t=>{t.preventDefault(),s.filters=[new PIXI.AlphaFilter(.4)],l.filters=[new PIXI.AlphaFilter(.4)]}),s.on("click",t=>{t.preventDefault(),this._levelMod=i.mod;try{let e=Number(i.mod);e>0?this._ring.bonus=this._initial.bonus+e:this._ring.penal=this._initial.penal+e,this._ring.value=this._initial.value+e}catch(s){this._ring.bonus=this._initial.bonus,this._ring.penal=this._initial.penal,this._ring.value=this._initial.value}this._mod.apply=0!==i.value,this._mod.text=i.label,this._mod.value=i.mod,this._drawRollRing(),this._drawModLevel(),this._optionsBox.destroy()}),this._optionsBox.addChild(l),this._optionsBox.addChild(s),u++});let x=new PIXI.Sprite(this._load.barLuckBack);x.width=.8*t.width,x.height=.035*t.height,x.x=t.x+.1*t.width,x.y=t.y+.25*t.height,this._optionsBox.addChild(x),x.filters=[new PIXI.AlphaFilter(.4)];let F=new PIXI.Sprite(this._load.barLuck);F.width=x.width,F.height=x.height,F.x=x.x,F.y=x.y;let w=0,_=i.spriteRounded(F.width,F.height,this.app.renderer,16777215,1);_.x=F.x,_.y=F.y;try{w=Number(r/o)}catch(v){w=0}_.width=_.width*w;let m=i.maskTransparent(F,_);this._optionsBox.addChild(m),m.filters=[new PIXI.AlphaFilter(.85)],i.haloAnimate(m,this.app._tickers,"barLuck",.1,16777215,1,1);let y=new PIXI.Sprite(this._load.seal);y.width=.12*t.width,y.height=.12*t.width,y.x=t.x+.81*t.width,y.y=4.2*t.y,this._optionsBox.addChild(y);let f=new PIXI.Sprite(this._load.sealX);f.width=.6*y.width,f.height=.6*y.width,f.x=y.x+.2*y.width,f.y=y.y+.2*y.height,f.filters=[new PIXI.AlphaFilter(.4)],this._optionsBox.addChild(f),f.interactive=!0,f.cursor="pointer",f.on("mousemove",t=>{t.preventDefault(),f.filters=[new PIXI.AlphaFilter(1)]}),f.on("mouseout",t=>{t.preventDefault(),f.filters=[new PIXI.AlphaFilter(.4)]}),f.on("click",t=>{this._optionsBox.destroy()}),this._layers.front.addChild(this._optionsBox)}_drawResult(t){let e=this._context.roll.evalResult(t,this._ring.value),s=e.criticalSuccess?"ringCriticalSuccess":e.criticalFailure?"ringCriticalFailure":e.success?"ringSuccess":"ringFailure",l=e.criticalSuccess?"#FFDD00":e.criticalFailure?"#FF0000":e.success?"#77BB77":"#BB7777",h=.125*this._canvas.height(),r=1.35*h;this._rollResult=new PIXI.Graphics().beginFill(0,1).lineStyle(1,16768256,1,1).drawCircle(0,0,h).endFill();let o=new PIXI.Sprite(this._load[s]);o.width=1.06*this._canvas.height(),o.height=1.06*this._canvas.height(),o.x=0,o.y=0,o.anchor.x=.5,o.anchor.y=.5,this._rollResult.addChild(o),function t(){requestAnimationFrame(t),o.rotation+=.1}();let a=i.spriteText(t,l,"#FFFFFF",1,r,"bold","#FFFFFF",5);a.y-=.15*r,this._rollResult.x=this._center.x,this._rollResult.y=this._center.y,this._rollResult.addChild(a),this._layers.front.addChild(this._rollResult)}applyLuck(){this._appliedLuck?(this._appliedLuck=!1,this.app._tickers.godRays&&(this.app._tickers.godRays.destroy(),this.app.stage.filters=[]),this._drawRollRing(),this._textLuck&&this._textLuck.destroy()):(this._appliedLuck=!0,i.godRays(this.app.stage,this.app._tickers,.02),this._drawRollRing(),this._drawLuck())}rollIt(){i.zoomBlurOUT(this.app.stage,this.app._tickers,this._center,.1*this._canvas.height(),.1,async()=>{this._levelMod=this._mod.apply?this._mod.value:this._levelMod;try{let t=new Roll(this._ring.formula);await t.evaluate(),game.dice3d&&($("#dice-box-canvas").css({zIndex:(Number($("#"+this._canvasID).css("zIndex"))+1).toString()}),await game.dice3d.showForRoll(t)),this._context.roll.closeTab(),this._drawResult(t.total),i.zoomBlurIN(this.app.stage,this.app._tickers,this._center,.1*this._canvas.height(),.05,()=>{this._removeCanvas(),this._context.roll.postRoll(t,this._ring.value,this._levelMod,this._appliedLuck)})}catch(e){this._removeCanvas()}})}}